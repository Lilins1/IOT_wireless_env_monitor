<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IoT Data Monitor</title>
  <link rel="stylesheet" href="style.css">
  <style>
    
  </style>
</head>
<body>
  <div class="container">
    <h1>IoT Sensor Dashboard</h1>
    
    <!-- Date Selection Card -->
    <div class="card">
      <h2>Historical Data</h2>
      <div class="filter-group">
        <input type="date" id="datePicker">
        <select id="hourFilter" disabled>
          <option value="all">All Hours</option>
        </select>
      </div>
      
    </div>

        <!-- Sensor Graph -->
        <div class="card">
          <h2>Sensor Data Charts</h2>
          <div class="charts-container">
            <div class="chart-wrapper">
              <canvas id="tempChart"></canvas>
            </div>
            <div class="chart-wrapper">
              <canvas id="humidityChart"></canvas>
            </div>
            <div class="chart-wrapper">
              <canvas id="lightChart"></canvas>
            </div>
          </div>
        </div>
      

      <div id="fileList" class="three-column-grid"></div>

    <!-- Historical Data Display -->
    <div class="card">
      <h2>Selected Data</h2>
      <div id="dataDisplay" class="data-display"></div>
    </div>

    <!-- Data Display Area -->
    <div class="card">
      <h2>Offline Data</h2>
      <div id="realtimeData" class="data-display"></div>
    </div>

  </div>

  <!-- 使用 ES 模块导入相关依赖 -->
  <script type="module">
    import { Chart, TimeScale, LineController, LineElement, PointElement, LinearScale, Title, Tooltip, Legend } 
      from 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/+esm';


    // 侧作用导入日期适配器模块，不做具名导入
    import 'https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/+esm';

    // 注册 Chart.js 组件
    Chart.register(TimeScale, LineController, LineElement, PointElement, LinearScale, Title, Tooltip, Legend);

    // 定义全局图表变量
    let tempChart, humidityChart, lightChart;

    // 监听小时筛选器变化，加载相应数据
    document.getElementById('hourFilter').addEventListener('change', async function() {
      const date = document.getElementById('datePicker').value;
      const hour = this.value;
      
      if (date && hour !== 'all') {
        try {
          console.log(`http://localhost:3000/api/hour-data?date=${date}&hour=${hour.padStart(2, '0')}`);
          const response = await fetch(`http://localhost:3000/api/hour-data?date=${date}&hour=${hour.padStart(2, '0')}`);
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const result = await response.json();
          
          if (result.dataCount === 0) {
            showError('No data available for selected hour');
            return;
          }
          
          updateCharts(result.data);
          
        } catch (error) {
          showError('Failed to load chart data: ' + error.message);
          console.error('Error details:', error);
        }
      } else {
        console.log('Error unexcute 148');
      }
    });

    // 更新图表函数：对数据排序、销毁旧图表并创建新图表
    function updateCharts(data) {
      const sortedData = data.sort((a, b) => a.TimeUnix - b.TimeUnix);

      [tempChart, humidityChart, lightChart].forEach(chart => {
        if (chart && typeof chart.destroy === 'function') {
          chart.destroy();
        }
      });

      tempChart = createChart(
        'tempChart',
        'Temperature (°F)',
        sortedData.map(d => d.Temp),
        'rgb(255, 99, 132)',
        sortedData.map(d => d.TimeUnix)
      );

      humidityChart = createChart(
        'humidityChart',
        'Humidity (%)',
        sortedData.map(d => d.Humidity),
        'rgb(54, 162, 235)',
        sortedData.map(d => d.TimeUnix)
      );

      lightChart = createChart(
        'lightChart',
        'Light Intensity',
        sortedData.map(d => d.Light),
        'rgb(255, 206, 86)',
        sortedData.map(d => d.TimeUnix)
      );
    }

    // 创建图表函数
    function createChart(canvasId, label, data, borderColor, timestamps) {
  // 计算起始时间，作为0分钟
  const baseTime = Math.min(...timestamps);
  return new Chart(document.getElementById(canvasId), {
    type: 'line',
    data: {
      datasets: [{
        label: label,
        data: timestamps.map((t, i) => ({
          x: (t - baseTime) / 60, // 转换为相对分钟数
          y: data[i]
        })),
        borderColor: borderColor,
        borderWidth: 2,
        pointRadius: 3,
        tension: 0.2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          type: 'linear',
          min: 0,
          max: 60,
          title: {
            display: true,
            text: 'Minutes'
          }
        },
        y: {
          title: {
            display: true,
            text: label
          },
          grace: '5%'
        }
      },
      plugins: {
        legend: {
          position: 'top'
        },
        tooltip: {
          mode: 'index',
          intersect: false,
          callbacks: {
            title: (items) => {
              return `Minute ${items[0].parsed.x.toFixed(0)}`;
            },
            label: (context) => {
              return `${label}: ${context.parsed.y.toFixed(2)}`;
            }
          }
        }
      }
    }
  });
}


    // 显示错误信息（将信息显示在 Selected Data 区域）
    function showError(message) {
      const container = document.getElementById('dataDisplay');
      container.innerHTML = `<div class="error-message">${message}</div>`;
    }
  </script>
  
  <!-- 非模块脚本部分 -->
  <script>
    // 日期选择器处理
    document.getElementById('datePicker').addEventListener('change', async (e) => {
      const date = e.target.value;
      try {
        const response = await fetch(`http://localhost:3000/api/files?date=${date}`);
        const files = await response.json();
        renderFiles(files);
      } catch (error) {
        showError('Failed to load files: ' + error.message);
      }
    });

    // 渲染文件列表
    function renderFiles(files) {
      const container = document.getElementById('fileList');
      const hourFilter = document.getElementById('hourFilter');
      
      // 从文件名提取小时信息（假设文件名为 HHMM 格式）
      const hourSet = new Set();
      files.forEach(file => {
        const filename = file.name.replace(/\..+$/, '');
        if (filename.match(/^\d{4}$/)) {
          hourSet.add(filename.substring(0, 2));
        }
      });
      
      // 生成小时筛选选项
      const hours = Array.from(hourSet).sort();
      hourFilter.innerHTML = '<option value="all">All Hours</option>' + 
        hours.map(h => `<option value="${h}">${h}:00 - ${h}:59</option>`).join('');
      hourFilter.disabled = false;

      updateFileDisplay(files, hourFilter.value);

      // 监听小时筛选变化
      hourFilter.addEventListener('change', () => {
        updateFileDisplay(files, hourFilter.value);
      });
    }

    // 更新文件显示函数
    function updateFileDisplay(files, selectedHour) {
      const container = document.getElementById('fileList');
      const filteredFiles = selectedHour === 'all' 
        ? files 
        : files.filter(file => {
            const filename = file.name.replace(/\..+$/, '');
            return filename.startsWith(selectedHour);
          });

      container.innerHTML = filteredFiles.length ? '' : '<div class="error-message">No files found</div>';
      
      // 按五列显示
      const columns = [[], [], [], [],[], [], [], [], [], []];
      filteredFiles.forEach((file, index) => {
        columns[index % 10].push(file);
      });

      columns.forEach(colFiles => {
        const colDiv = document.createElement('div');
        colDiv.className = 'file-column';
        colFiles.forEach(file => {
          const link = document.createElement('a');
          link.href = '#';
          const time = file.name.replace(/\..+$/, '');
          link.textContent = `${time.substring(0,2)}:${time.substring(2)}`;
          link.onclick = () => loadFileData(file.path);
          colDiv.appendChild(link);
        });
        container.appendChild(colDiv);
      });
    }

    // 加载并显示文件数据
    async function loadFileData(filePath) {
      try {
        const response = await fetch(`http://localhost:3000/api/file?path=${encodeURIComponent(filePath)}`);
        const data = await response.json();
        renderDataTable(data);
      } catch (error) {
        showError('Failed to load data: ' + error.message);
      }
    }

    // 渲染数据表格
    function renderDataTable(data) {
      const container = document.getElementById('dataDisplay');
      const headers = Object.keys(data[0]);
      
      const tableHTML = `
        <table>
          <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
          <tbody>
            ${data.map(row => `
              <tr>${headers.map(h => `<td>${row[h]}</td>`).join('')}</tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      container.innerHTML = tableHTML;
    }

    // 显示错误信息（此处错误信息显示在文件列表中）
    function showError(message) {
      const container = document.getElementById('fileList');
      container.innerHTML = `<div class="error-message">${message}</div>`;
    }

    // 实时数据更新
    async function updateRealTimeData() {
      try {
        const response = await fetch('DataSet_real_time.TXT');
        const data = await response.text();
        document.getElementById('realtimeData').innerHTML = data.replace(/\n/g, '<br>');
      } catch (error) {
        console.error('Error fetching realtime data:', error);
      }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      updateRealTimeData();
      setInterval(updateRealTimeData, 10000);
    });
  </script>
</body>
</html>
